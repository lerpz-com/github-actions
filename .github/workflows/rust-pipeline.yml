name: Project pipeline to deploy rust projects using containers

on:
  workflow_call:

jobs:
  prepare-pipeline:
    uses: ./.github/workflows/prepare-pipeline.yml
    secrets: inherit

  terraform:
    uses: ./.github/workflows/terraform.yml
    needs: [prepare-pipeline, build-and-push-image]
    secrets: inherit
    with:
      deploy_env: ${{ needs.prepare-pipeline.outputs.deploy_env }}

  rust-lint:
    uses: ./.github/workflows/rust-lint-and-test.yml
    needs: [prepare-pipeline]
    secrets: inherit
    with:
      deploy_env: ${{ needs.prepare-pipeline.outputs.deploy_env }}

  build-and-push-image:
    uses: ./.github/workflows/docker-build-and-push.yml
    needs: [prepare-pipeline, rust-lint]
    secrets: inherit
    with:
      deploy_env: ${{ needs.prepare-pipeline.outputs.deploy_env }}
      image_name: ${{ needs.prepare-pipeline.outputs.image_name }}

  deploy-azure:
    uses: ./.github/workflows/deploy-azure.yml
    if: ${{ needs.prepare-pipeline.outputs.DEPLOY_PLATFORM == 'azure' }}
    needs: [prepare-pipeline, build-and-push-image]
    secrets: inherit
    with:
      project_type: ${{ needs.prepare-pipeline.outputs.PROJECT_TYPE }}
      deploy_env: ${{ needs.prepare-pipeline.outputs.DEPLOY_ENV }}
      image_path: ${{ needs.build-and-push-image.outputs.image_path }}
