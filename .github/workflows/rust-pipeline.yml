name: Project pipeline to deploy rust projects using containers

on:
  workflow_call:

jobs:
  prepare-pipeline:
    uses: ./.github/workflows/prepare-pipeline.yml
    secrets: inherit

  terraform:
    uses: ./.github/workflows/terraform.yml
    needs: [prepare-pipeline]
    secrets: inherit
    with:
      DEPLOY_ENV: ${{ needs.prepare-pipeline.outputs.DEPLOY_ENV }}

  rust-lint:
    uses: ./.github/workflows/rust-lint-and-test.yml
    needs: [prepare-pipeline]
    secrets: inherit
    with:
      DEPLOY_ENV: ${{ needs.prepare-pipeline.outputs.DEPLOY_ENV }}

  build-and-push-image:
    uses: ./.github/workflows/container-build-and-push.yml
    needs: [prepare-pipeline, rust-lint]
    secrets: inherit
    with:
      DEPLOY_ENV: ${{ needs.prepare-pipeline.outputs.DEPLOY_ENV }}
      IMAGE_NAME: ${{ needs.prepare-pipeline.outputs.IMAGE_NAME }}

  deploy-aci:
    uses: ./.github/workflows/deploy-aci.yml
    needs: [prepare-pipeline, terraform, build-and-push-image]
    secrets: inherit
    with:
      DEPLOY_ENV: ${{ needs.prepare-pipeline.outputs.DEPLOY_ENV }}
      IMAGE_PATH: ${{ needs.build-and-push-image.outputs.IMAGE_PATH }}

